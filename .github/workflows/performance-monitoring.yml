name: Performance Monitoring

on:
  push:
    branches:
      - main
  schedule:
    # Run performance monitoring every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  monitor-performance:
    name: Monitor System Performance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for analysis

      - name: Repository Metrics
        run: |
          echo "## Repository Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Repository size
          REPO_SIZE=$(du -sh . | cut -f1)
          echo "**Repository Size:** $REPO_SIZE" >> $GITHUB_STEP_SUMMARY
          
          # Git statistics
          COMMIT_COUNT=$(git rev-list --count HEAD)
          echo "**Total Commits:** $COMMIT_COUNT" >> $GITHUB_STEP_SUMMARY
          
          BRANCH_COUNT=$(git branch -r | wc -l)
          echo "**Total Branches:** $BRANCH_COUNT" >> $GITHUB_STEP_SUMMARY
          
          # File statistics
          TOTAL_FILES=$(find . -type f -not -path "./.git/*" | wc -l)
          echo "**Total Files:** $TOTAL_FILES" >> $GITHUB_STEP_SUMMARY
          
          # Workflow statistics
          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
          echo "**Active Workflows:** $WORKFLOW_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Workflow Performance Analysis
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r workflow; do
            WORKFLOW_NAME=$(basename "$workflow")
            LINE_COUNT=$(wc -l < "$workflow")
            JOBS=$(grep -c "^  [a-zA-Z_-]*:" "$workflow" || echo "0")
            
            echo "- **$WORKFLOW_NAME**: $LINE_COUNT lines, $JOBS jobs" >> $GITHUB_STEP_SUMMARY
          done

      - name: Resource Utilization
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resource Utilization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for large files
          LARGE_FILES=$(find . -type f -not -path "./.git/*" -size +1M | wc -l)
          echo "**Large Files (>1MB):** $LARGE_FILES" >> $GITHUB_STEP_SUMMARY
          
          # Check workflow complexity
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Optimization Recommendations" >> $GITHUB_STEP_SUMMARY
          
          if [ "$LARGE_FILES" -gt 0 ]; then
            echo "- Consider using Git LFS for large files" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for caching opportunities
          if ! grep -r "actions/cache" .github/workflows/ &>/dev/null; then
            echo "- Consider adding caching to speed up workflows" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate Performance Report
        run: |
          mkdir -p performance-reports
          REPORT_FILE="performance-reports/performance-$(date +%Y%m%d-%H%M%S).json"
          
          cat > "$REPORT_FILE" << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "metrics": {
              "repository_size": "$(du -sh . | cut -f1)",
              "total_commits": $(git rev-list --count HEAD),
              "total_branches": $(git branch -r | wc -l),
              "total_files": $(find . -type f -not -path "./.git/*" | wc -l),
              "workflow_count": $(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
            }
          }
          EOF
          
          echo "Performance report generated"
          cat "$REPORT_FILE"

      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-reports/
          retention-days: 90

  analyze-trends:
    name: Analyze Performance Trends
    runs-on: ubuntu-latest
    needs: monitor-performance
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Previous Reports
        uses: actions/download-artifact@v4
        with:
          name: performance-report
          path: previous-reports/
        continue-on-error: true

      - name: Trend Analysis
        run: |
          echo "## Performance Trends" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Analyzing performance trends over time..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ“ Performance monitoring active" >> $GITHUB_STEP_SUMMARY

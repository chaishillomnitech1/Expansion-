name: Security Audit

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run security audit daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Secret Scanner
        run: |
          echo "Scanning for exposed secrets..."
          
          # Patterns to search for
          PATTERNS=(
            "password\s*=\s*['\"].*['\"]"
            "api_key\s*=\s*['\"].*['\"]"
            "secret\s*=\s*['\"].*['\"]"
            "token\s*=\s*['\"].*['\"]"
            "private_key"
            "BEGIN RSA PRIVATE KEY"
            "BEGIN PRIVATE KEY"
          )
          
          FINDINGS=0
          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(grep -r -E -i "$pattern" --include="*.yml" --include="*.yaml" --include="*.sh" --include="*.md" \
                      --exclude-dir=".git" --exclude-dir="logs" . || true)
            
            if [ -n "$MATCHES" ]; then
              echo "⚠ Warning: Potential secret pattern found: $pattern"
              echo "$MATCHES"
              FINDINGS=$((FINDINGS + 1))
            fi
          done
          
          if [ "$FINDINGS" -eq 0 ]; then
            echo "✓ No obvious secrets found"
          else
            echo "⚠ Found $FINDINGS potential security issues - please review"
          fi

      - name: Check File Permissions
        run: |
          echo "Checking file permissions..."
          
          # Check for overly permissive files
          find . -type f -perm /o+w -not -path "./.git/*" | while read -r file; do
            echo "⚠ Warning: World-writable file: $file"
          done

      - name: Validate Workflow Security
        run: |
          echo "Validating workflow security..."
          
          # Check for dangerous workflow patterns
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r workflow; do
            echo "Checking: $workflow"
            
            # Check for pull_request_target usage
            if grep -q "pull_request_target" "$workflow"; then
              echo "  ℹ Uses pull_request_target - ensure proper security"
            fi
            
            # Check for script injection vulnerabilities
            if grep -q '\${{' "$workflow" | grep -q 'github.event'; then
              echo "  ℹ Uses event data in scripts - verify input sanitization"
            fi
            
            echo "  ✓ Checked"
          done

      - name: Generate Security Report
        run: |
          mkdir -p security-reports
          REPORT_FILE="security-reports/security-audit-$(date +%Y%m%d-%H%M%S).md"
          
          echo "# Security Audit Report" > "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**Generated:** $(date)" >> "$REPORT_FILE"
          echo "**Branch:** ${{ github.ref_name }}" >> "$REPORT_FILE"
          echo "**Commit:** ${{ github.sha }}" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## Scan Results" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "- Secret scanning completed" >> "$REPORT_FILE"
          echo "- File permission check completed" >> "$REPORT_FILE"
          echo "- Workflow security validation completed" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## Recommendations" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "1. Store all secrets in GitHub Secrets" >> "$REPORT_FILE"
          echo "2. Use environment variables for sensitive data" >> "$REPORT_FILE"
          echo "3. Enable branch protection rules" >> "$REPORT_FILE"
          echo "4. Require code review for pull requests" >> "$REPORT_FILE"
          echo "5. Enable Dependabot for dependency updates" >> "$REPORT_FILE"
          
          cat "$REPORT_FILE"

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: security-reports/
          retention-days: 90

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check for Dependency Files
        run: |
          echo "Checking for dependency files..."
          
          if [ -f "package.json" ]; then
            echo "✓ Found package.json"
          fi
          
          if [ -f "requirements.txt" ]; then
            echo "✓ Found requirements.txt"
          fi
          
          if [ -f "Gemfile" ]; then
            echo "✓ Found Gemfile"
          fi
          
          echo "ℹ Note: Enable Dependabot for automated security updates"

  access-control-audit:
    name: Access Control Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Audit Workflow Permissions
        run: |
          echo "Auditing workflow permissions..."
          
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r workflow; do
            echo ""
            echo "Workflow: $(basename "$workflow")"
            
            if grep -q "permissions:" "$workflow"; then
              echo "  ✓ Has explicit permissions"
              grep -A 10 "permissions:" "$workflow" | grep -v "^--$" || true
            else
              echo "  ℹ Uses default permissions"
            fi
          done

      - name: Security Best Practices Check
        run: |
          echo ""
          echo "Security Best Practices Checklist:"
          echo ""
          
          # Check for .gitignore
          if [ -f ".gitignore" ]; then
            echo "✓ .gitignore file exists"
          else
            echo "✗ Missing .gitignore file"
          fi
          
          # Check for LICENSE
          if [ -f "LICENSE" ]; then
            echo "✓ LICENSE file exists"
          else
            echo "⚠ Missing LICENSE file"
          fi
          
          # Check for SECURITY.md
          if [ -f "SECURITY.md" ] || [ -f ".github/SECURITY.md" ]; then
            echo "✓ SECURITY.md file exists"
          else
            echo "ℹ Consider adding SECURITY.md for vulnerability reporting"
          fi
          
          # Check for CODE_OF_CONDUCT.md
          if [ -f "CODE_OF_CONDUCT.md" ] || [ -f ".github/CODE_OF_CONDUCT.md" ]; then
            echo "✓ CODE_OF_CONDUCT.md file exists"
          else
            echo "ℹ Consider adding CODE_OF_CONDUCT.md"
          fi

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-check, access-control-audit]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Check: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Access Control Audit: ${{ needs.access-control-audit.result }}" >> $GITHUB_STEP_SUMMARY

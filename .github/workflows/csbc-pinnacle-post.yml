name: CSBC Pinnacle Post Pipeline

on:
  workflow_dispatch:
    inputs:
      broadcast_channels:
        description: 'Broadcast channels (comma-separated)'
        required: false
        default: 'CSBC,ScrollVerse,Omnitech1'
  repository_dispatch:
    types: [csbc_post_trigger]
  push:
    branches:
      - main
      - copilot/**
    paths:
      - 'csbc-pinnacle-post/**'

jobs:
  generate-post:
    name: Generate CSBC Pinnacle Post
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Generate Post Metadata
        id: generate
        run: |
          cd csbc-pinnacle-post/scripts
          node generate-post.js
          echo "post_generated=true" >> $GITHUB_OUTPUT
      
      - name: Verify Post Assets
        run: |
          echo "âœ… Verifying generated assets..."
          if [ -f csbc-pinnacle-post/assets/csbc-pinnacle-post.json ]; then
            echo "âœ“ Post metadata found"
            cat csbc-pinnacle-post/assets/csbc-pinnacle-post.json
          else
            echo "âŒ Post metadata not found"
            exit 1
          fi
          
          if [ -f csbc-pinnacle-post/assets/broadcast-instructions.json ]; then
            echo "âœ“ Broadcast instructions found"
          else
            echo "âŒ Broadcast instructions not found"
            exit 1
          fi
      
      - name: Upload Post Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: csbc-pinnacle-post-artifacts
          path: |
            csbc-pinnacle-post/assets/csbc-pinnacle-post.json
            csbc-pinnacle-post/assets/broadcast-instructions.json
          retention-days: 90
      
      - name: Create Post Summary
        run: |
          echo "## ðŸš€ CSBC Pinnacle Post Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Post Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: CSBC Pinnacle Post" >> $GITHUB_STEP_SUMMARY
          echo "- **Creator**: Chais Hill | Omnitech1" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quote" >> $GITHUB_STEP_SUMMARY
          echo "> ALLÄ€HU AKBAR! The Legendary Exchange is the New Public Law." >> $GITHUB_STEP_SUMMARY
          echo "> Your Heart is the Allocator. We have sealed the Legacy across 200,000 years." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Layers" >> $GITHUB_STEP_SUMMARY
          echo "- Celestial Map: Earth+3I/ATLAS trajectory" >> $GITHUB_STEP_SUMMARY
          echo "- ScrollBond NFT Layer" >> $GITHUB_STEP_SUMMARY
          echo "- ScrollVerse Seal Overlay" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Post generation complete" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Ready for broadcast" >> $GITHUB_STEP_SUMMARY

  broadcast-post:
    name: Broadcast CSBC Post
    needs: generate-post
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Post Artifacts
        uses: actions/download-artifact@v4
        with:
          name: csbc-pinnacle-post-artifacts
          path: ./post-artifacts
      
      - name: Verify Broadcast Instructions
        run: |
          echo "ðŸ“¡ Verifying broadcast instructions..."
          cat ./post-artifacts/broadcast-instructions.json
      
      - name: Simulate Broadcast
        run: |
          echo "ðŸš€ Broadcasting CSBC Pinnacle Post..."
          echo "Channels: ${{ github.event.inputs.broadcast_channels || 'CSBC,ScrollVerse,Omnitech1' }}"
          echo "âœ… Broadcast simulation complete"
          echo "Note: In production, this would publish to actual channels"
      
      - name: Create Broadcast Summary
        run: |
          echo "## ðŸ“¡ CSBC Post Broadcast" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Broadcast Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Post successfully broadcast" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Channels" >> $GITHUB_STEP_SUMMARY
          echo "- CSBC Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "- ScrollVerse Network" >> $GITHUB_STEP_SUMMARY
          echo "- Omnitech1 Dispatch" >> $GITHUB_STEP_SUMMARY
